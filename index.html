<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>O Bestiário do Herói — v2.0 “O Eterno Retorno (Amplificado)”</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <link rel="stylesheet" href="style.css" />
    <meta name="description" content="Protótipo ampliado — VN extensa, bestiário aprofundado e combate por padrões.">
</head>

<body>
    <div id="app" class="wrap" role="application" aria-label="O Bestiário do Herói">
        <main id="game" class="card" aria-live="polite">
            <canvas id="c" width="1024" height="540" role="img" aria-label="Área de combate"></canvas>

            <section id="vnContainer" class="vn-box fade hidden" aria-hidden="true">
                <div class="vn-inner">
                    <img id="vnPortrait" class="portrait" alt="Retrato do personagem" />
                    <div style="flex:1">
                        <div id="vnSpeaker" class="muted" aria-hidden="false"></div>
                        <div id="vnText" class="vn-text" aria-live="polite"></div>
                        <div class="vn-controls">
                            <button id="vnAuto" class="secondary">Auto</button>
                            <button id="vnNext">Continuar</button>
                            <button id="vnSkip" class="secondary">Pular VN</button>
                        </div>
                    </div>
                </div>
                <div id="vnProgress" class="vn-progress" aria-hidden="true"></div>
            </section>

            <section id="interludeBox" class="vn-box hidden" aria-hidden="true">
                <div id="interludeText" class="vn-text"></div>
                <div class="vn-controls interlude-controls">
                    <button id="interludeContinue">Prosseguir</button>
                </div>
            </section>

            <div id="hudMini" class="hud-mini" aria-hidden="false">
                <div id="chapterLabel" class="muted">Capítulo 1</div>
                <div id="audioControls">
                    <button id="btnToggleMusic" title="Ativar / Desativar música">♪</button>
                </div>
            </div>
        </main>

        <aside id="ui">
            <section class="card" aria-label="Controles e ações">
                <h2>O Bestiário do Herói — v2.0</h2>
                <div class="muted">Modo atual: <strong id="modeLabel">Intro</strong></div>

                <div class="controls-grid">
                    <button id="openBest">Bestiário</button>
                    <button id="openVN" class="secondary">Ver Prólogo (VN)</button>
                    <button id="executarAcao">Executar Ação</button>
                    <button id="resetPattern">Resetar</button>
                    <button id="nextBoss" style="display:none">Arena</button>
                </div>

                <div style="margin-top:12px" class="stat">
                    <div class="muted">Sequência registrada:</div>
                    <div id="patternContainer" style="min-height:36px" aria-live="polite"></div>
                </div>

                <div style="margin-top:12px" class="muted">Configurações</div>
                <div class="small-settings">
                    <label>Volume música <input type="range" id="musicVol" min="0" max="1" step="0.01"
                            value="0.6" /></label>
                    <label>Volume SFX <input type="range" id="sfxVol" min="0" max="1" step="0.01" value="0.9" /></label>
                    <label><input type="checkbox" id="accessSub" checked /> Legendas VN</label>
                </div>
            </section>

            <section class="card" aria-label="Log de Batalha">
                <h2 class="center">Log de Batalha</h2>
                <div id="log" role="log" aria-live="polite"></div>
            </section>

            <section class="card" aria-label="Como jogar">
                <div class="muted">Como Jogar:</div>
                <ul>
                    <li>Leia a VN longa; o prólogo é essencial para a melancolia do herói anterior.</li>
                    <li>Abra o Bestiário para ver padrões; reproduza-os na sequência.</li>
                    <li>Use teclado ou botões na tela; 3 erros = dano.</li>
                    <li>Há finais alternativos — explore anotações, queimas e segredos.</li>
                </ul>
                <footer>Protótipo v2.0 — O Eterno Retorno (Amplificado)</footer>
            </section>
        </aside>
    </div>

    <div id="bestiaryModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="bestiaryTitle">
        <div class="modal-inner">
            <div class="modal-header">
                <h3 id="bestiaryTitle">Bestiário</h3>
                <div class="bestiary-actions">
                    <input id="bestiarySearch" placeholder="Pesquisar..." aria-label="Pesquisar bestiário" />
                    <button id="closeBest" class="secondary">Fechar</button>
                </div>
            </div>

            <div class="modal-body">
                <div style="flex:1">
                    <div id="bestiaryList" class="bestiary-grid" role="list"></div>
                    <div id="bestiaryPager" class="pager"></div>
                </div>
                <aside class="bestiary-sidebar">
                    <div id="bestiaryPreview"><em>Selecione uma entrada para ver detalhes e notas</em></div>
                </aside>
            </div>
        </div>
    </div>

    <div id="gameOverModal" class="modal hidden" role="dialog" aria-modal="true">
        <div class="modal-inner center" style="background:#06202a;color:#eaf6ff;padding:24px;border-radius:10px;">
            <h3 style="color:#e11d48">GAME OVER</h3>
            <p id="gameOverText">Sua jornada termina por enquanto.</p>
            <div style="margin-top:12px"><button id="restartGame">Tentar Novamente</button></div>
        </div>
    </div>

    <div id="onScreenControls" class="controls" aria-hidden="false">
        <div class="dpad">
            <div></div>
            <div class="control-btn" id="btn-up" role="button" aria-label="up">↑</div>
            <div></div>
            <div class="control-btn" id="btn-left" role="button" aria-label="left">←</div>
            <div class="control-btn" id="btn-down" role="button" aria-label="down">↓</div>
            <div class="control-btn" id="btn-right" role="button" aria-label="right">→</div>
        </div>
        <div class="action-btns">
            <div class="control-btn big-btn" id="btn-attack" role="button" aria-label="attack">⚔</div>
            <div class="control-btn big-btn" id="btn-special" role="button" aria-label="special">✨</div>
        </div>
    </div>

    <!-- audio.js is intentionally loaded; you said keep everything except audio content -->
    <script src="audio.js"></script>

    <script src="data.js"></script>
    <script src="assets.js"></script>
    <script src="ui.js"></script>
    <script src="game.js"></script>

    <script>
        // Init: load assets and start main loop when ready
        (function () {
            const canvas = document.getElementById('c');
            if (!window.GameAssets) return;

            const progressCB = (p) => {
                window.GameAssets._loadedAssets = Math.round(p * window.GameAssets._totalAssets);
            };

            GameAssets.loadAll(progressCB, () => {
                // start drawing loop after assets loaded
                if (window._GAME && window._GAME.startLoop) window._GAME.startLoop();

                // attach sliders to Audio API if present
                const musicVol = document.getElementById('musicVol');
                const sfxVol = document.getElementById('sfxVol');
                if (window.AudioAPI && window.AudioAPI.setMusicVolume) {
                    window.AudioAPI.setMusicVolume(parseFloat(localStorage.getItem('musicVol') || musicVol.value));
                }
                if (window.AudioAPI && window.AudioAPI.setSfxVolume) {
                    window.AudioAPI.setSfxVolume(parseFloat(localStorage.getItem('sfxVol') || sfxVol.value));
                }

                // attach slider handlers
                musicVol.oninput = (e) => {
                    localStorage.setItem('musicVol', e.target.value);
                    if (window.AudioAPI && window.AudioAPI.setMusicVolume) window.AudioAPI.setMusicVolume(parseFloat(e.target.value));
                };
                sfxVol.oninput = (e) => {
                    localStorage.setItem('sfxVol', e.target.value);
                    if (window.AudioAPI && window.AudioAPI.setSfxVolume) window.AudioAPI.setSfxVolume(parseFloat(e.target.value));
                };

                // toggle music button
                const btnToggle = document.getElementById('btnToggleMusic');
                btnToggle.onclick = () => {
                    const enabled = !(localStorage.getItem('musicEnabled') === 'true');
                    localStorage.setItem('musicEnabled', enabled ? 'true' : 'false');
                    if (window.AudioAPI && window.AudioAPI.toggleMaster) window.AudioAPI.toggleMaster(enabled);
                    btnToggle.textContent = enabled ? '♪' : '╳';
                };
                // initialize toggle text
                const enabledStored = localStorage.getItem('musicEnabled');
                if (enabledStored === 'false') btnToggle.textContent = '╳';

                // optionally auto-start light music (user needs gesture to start audio context on some browsers)
                document.body.addEventListener('pointerdown', async function once() {
                    if (window.AudioAPI && window.AudioAPI.startMusic) {
                        try { await window.AudioAPI.startMusic(); } catch (e) { /* ignore */ }
                    }
                    document.body.removeEventListener('pointerdown', once);
                });
            });
        })();
    </script>
</body>

</html>